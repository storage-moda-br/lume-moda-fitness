<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Editar Produto – Lume Moda Fitness</title>
<style>
  :root{--ink:#111;--muted:#6b6b6b;--ring:#e5e7eb;--ok:#16a34a;--err:#dc2626;--bg:#f7f7f8}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg)}
  header{display:flex;gap:10px;align-items:center;padding:14px 16px;background:#000;color:#fff}
  header a{color:#fff;text-decoration:none;opacity:.9}
  header a:active{opacity:.7}
  .wrap{max-width:820px;margin:18px auto;padding:0 14px}
  .form{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#fff;border:1px solid var(--ring);border-radius:14px;padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="text"], textarea{
    width:100%;padding:12px;border:1px solid var(--ring);border-radius:10px;font-size:14px;background:#fff
  }
  textarea{min-height:120px;resize:vertical}
  .preview{aspect-ratio:4/5;background:#fafafa;border:1px dashed var(--ring);border-radius:14px;overflow:hidden;display:flex;align-items:center;justify-content:center}
  .preview img{width:100%;height:100%;object-fit:cover}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{border:0;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer}
  .btn-primary{background:#000;color:#fff}
  .btn-ghost{background:#fff;color:#000;border:1px solid var(--ring)}
  .note{color:var(--muted);font-size:12px}
  .ok{color:var(--ok);font-weight:600}
  .err{color:var(--err);font-weight:600}
  .progress{height:8px;background:#eee;border-radius:999px;overflow:hidden}
  .progress > div{height:100%;width:0%;background:#000;transition:width .2s ease}

  @media (max-width: 820px){
    .wrap{padding:10px}
    .form{grid-template-columns:1fr}
    .btn{width:100%;padding:14px}
    input[type="text"], textarea{font-size:16px}
  }

  .toast{
    position: fixed;
    top: -60px;
    left: 50%;
    transform: translateX(-50%);
    background: #2ecc71;
    color: #fff;
    padding: 12px 22px;
    font-size: 15px;
    border-radius: 50px;
    box-shadow: 0 3px 10px rgba(0,0,0,.25);
    z-index: 9999;
    opacity: 0;
    transition: all .5s ease;
  }
  .toast.show{
    top: 20px;
    opacity: 1;
  }
  .slotExtra:hover .delExtra{
    display:flex !important;
  }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">
</head>
<body>
<div id="toast" class="toast">Produto salvo com sucesso!</div>

<header>
  <a href="painel.html">← Voltar</a>
  <strong id="titulo">Editar produto</strong>
</header>

<div class="wrap">
  <div class="form">
    <div class="card">
      <div class="preview" id="preview"><span class="note">Prévia da imagem</span></div>
      <div id="cropArea" style="display:none; margin-top:10px;">
        <img id="cropImg" style="max-width:100%; display:block;">
        <button id="btnApplyCrop" class="btn btn-primary" type="button" style="margin-top:10px;width:100%;">
          Aplicar corte e usar esta imagem
        </button>
      </div>
      <div style="margin-top:10px" class="row">
        <input id="file" type="file" accept="image/*" style="display:none">
        <input id="fileExtra" type="file" accept="image/*" style="display:none">
        <button id="btnSelectImage" class="btn btn-primary" type="button">Selecionar foto</button>

        <div style="margin-top:14px;font-size:12px;color:#555;font-weight:600;">Fotos extras (até 5):</div>
        <div id="extraImagesWrap" style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap;">
          <div class="slotExtra" data-slot="0" style="width:59px;height:74px;position:relative;background:#fafafa;border:1px dashed #ccc;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:22px;color:#999;cursor:pointer;">+</div>
          <div class="slotExtra" data-slot="1" style="width:59px;height:74px;position:relative;background:#fafafa;border:1px dashed #ccc;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:22px;color:#999;cursor:pointer;">+</div>
          <div class="slotExtra" data-slot="2" style="width:59px;height:74px;position:relative;background:#fafafa;border:1px dashed #ccc;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:22px;color:#999;cursor:pointer;">+</div>
          <div class="slotExtra" data-slot="3" style="width:59px;height:74px;position:relative;background:#fafafa;border:1px dashed #ccc;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:22px;color:#999;cursor:pointer;">+</div>
          <div class="slotExtra" data-slot="4" style="width:59px;height:74px;position:relative;background:#fafafa;border:1px dashed #ccc;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:22px;color:#999;cursor:pointer;">+</div>
        </div>
      </div>
      <div style="margin-top:10px" class="progress" aria-hidden="true"><div id="bar"></div></div>
      <div id="progText" class="note" style="margin-top:6px"></div>
    </div>
    <!-- Lado do formulário -->
    <div class="card">
      <div style="margin-bottom:10px">
        <label for="nome">Nome do produto</label>
        <input id="nome" type="text" placeholder="Ex.: Corta vento"/>
      </div>
      <div style="margin-bottom:10px">
        <label for="preco">Preço (R$)</label>
        <input id="preco" type="text" inputmode="decimal" pattern="[0-9]+([,\.][0-9]{1,2})?" placeholder="Ex.: 89,90"/>
      </div>
      <div style="margin-bottom:12px">
        <label for="descricao">Descrição</label>
        <textarea id="descricao" placeholder="Ex.: Corta vento R$ 89,90 ..."></textarea>
      </div>
      <div class="row">
        <button id="salvar" class="btn btn-primary">Salvar produto</button>
        <button id="copiarLink" class="btn btn-ghost" type="button">Copiar link da imagem</button>
        <span id="status" class="note"></span>
      </div>
    </div>
  </div>
</div>

<script type="module">
import Cropper from "https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.esm.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

let cropper = null;
let croppedBlob = null;
let autoSave = false;

const firebaseConfig = {
  apiKey: "AIzaSyBzzYviQCkPUeRSCMZ-sxJiQlKGgUFy8xk",
  authDomain: "lume-moda-fitness.firebaseapp.com",
  projectId: "lume-moda-fitness",
  storageBucket: "lume-moda-fitness.firebasestorage.app",
  messagingSenderId: "485446426887",
  appId: "1:485446426887:web:93ba7f4b9d4f199af7e5a2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app, "firestore");
const st = getStorage(app, "lume-moda-fitness.firebasestorage.app");

const params = new URLSearchParams(location.search);
const pid = params.get('pid') || 'produto01';
document.getElementById('titulo').textContent = `Editar ${pid}`;

const elNome = document.getElementById('nome');
const elPreco = document.getElementById('preco');
const elDesc = document.getElementById('descricao');
const elFile = document.getElementById('file');
const elPrev = document.getElementById('preview');
const elSalvar = document.getElementById('salvar');
const elStatus = document.getElementById('status');
const elCopiar = document.getElementById('copiarLink');
const elBar = document.getElementById('bar');
const elProg = document.getElementById('progText');

let currentImageUrl = "";
let extraImages = [];
let currentSlotEdit = null;
let editingExtra = false;
let extraBlobs = [];

/* =============== CARREGA PRODUTO =============== */
(async () => {
  try{
    const refDoc = doc(db, 'produtos', pid);
    const snap = await getDoc(refDoc);
    if (snap.exists()){
      const d = snap.data();
      elNome.value = d.nome || "";
      elDesc.value = d.descricao || "";
      elPreco.value = (typeof d.preco === 'number' ? d.preco.toFixed(2) : (d.preco || "")).toString().replace('.', ',');

      if (d.imagem){
        currentImageUrl = d.imagem;
        elPrev.innerHTML = `<img src="${d.imagem}" alt="">`;
      }

      // converte objeto → array e limpa
      if (Array.isArray(d.imagens)) extraImages = d.imagens;
      else if (d.imagens && typeof d.imagens === "object") extraImages = Object.values(d.imagens);
      else extraImages = [];

      extraImages = extraImages.filter(u => u).slice(0,5);
      extraBlobs = new Array(extraImages.length).fill(null);
      renderExtraSlots();
    }
  } catch(err){
    console.error(err);
  }
})(); // FECHA BLOCO ASSÍNCRONO

/* =============== FUNÇÃO DE RENDERIZAÇÃO =============== */
function renderExtraSlots(){
  const wrap = document.getElementById("extraImagesWrap");
  const slots = wrap.querySelectorAll(".slotExtra");
  slots.forEach((slot, idx)=>{
    const url = extraImages[idx];
    if (url){
      slot.innerHTML = `
        <img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">
        <div class="delExtra" data-idx="${idx}" style="
            position:absolute;top:4px;right:4px;
            background:rgba(0,0,0,0.6);color:#fff;
            width:18px;height:18px;font-size:14px;
            border-radius:4px;display:flex;
            align-items:center;justify-content:center;
            cursor:pointer;">×</div>
      `;
    } else {
      slot.innerHTML = "+";
    }
  });
}

/* =============== EVENTOS =============== */
document.querySelectorAll(".slotExtra").forEach(slot=>{
  slot.addEventListener("click",()=>{
    currentSlotEdit = parseInt(slot.dataset.slot);
    editingExtra = true;
    document.getElementById("fileExtra").click();
  });
});

/* exclusão das imagens extras (sem abrir seletor) */
document.addEventListener("click", (ev) => {
  const btn = ev.target.closest(".delExtra");
  if (!btn) return;

  // impede o clique de “vazar” pro slot
  ev.stopImmediatePropagation();
  ev.preventDefault();

  const idx = parseInt(btn.dataset.idx);
  extraImages[idx] = null;
  extraBlobs[idx] = null;
  renderExtraSlots();
});


/* selecionar imagem principal */
elFile.addEventListener('change', () => {
  const f = elFile.files?.[0];
  if (!f) return;
  croppedBlob = null;
  elPrev.style.display = "none";
  document.getElementById("cropArea").style.display = "block";
  const cropImg = document.getElementById("cropImg");
  const reader = new FileReader();
  reader.onload = () => {
    cropImg.src = reader.result;
    if (cropper) cropper.destroy();
    cropper = new Cropper(cropImg, {
      aspectRatio: 4/5,
      viewMode: 1,
      dragMode: 'move',
      autoCropArea: 1
    });
  };
  reader.readAsDataURL(f);
});

/* selecionar imagem extra */
document.getElementById("fileExtra").addEventListener("change", () => {
  const f = document.getElementById("fileExtra").files?.[0];
  if (!f) return;
  croppedBlob = null;
  elPrev.style.display = "none";
  document.getElementById("cropArea").style.display = "block";
  const cropImg = document.getElementById("cropImg");
  const reader = new FileReader();
  reader.onload = () => {
    cropImg.src = reader.result;
    if (cropper) cropper.destroy();
    cropper = new Cropper(cropImg, {
      aspectRatio: 4/5,
      viewMode: 1,
      dragMode: 'move',
      autoCropArea: 1
    });
  };
  reader.readAsDataURL(f);
});

/* utilidades */
function normalizePrecoToNumber(v){
  if (!v) return 0;
  const cleaned = v.replace(/\s/g,'').replace(/\./g,'').replace(',', '.');
  const n = parseFloat(cleaned);
  return Number.isFinite(n) ? n : 0;
}

function showToast(){
  if (autoSave) return;
  const t = document.getElementById("toast");
  t.classList.add("show");
  setTimeout(()=>{
    t.classList.remove("show");
    if (!autoSave){
      setTimeout(()=>{
        window.location.href = "painel.html";
      }, 400);
    }
  }, 1400);
}

/* aplicar corte */
document.getElementById("btnApplyCrop").addEventListener("click", () => {
  if (!cropper) return;
  cropper.getCroppedCanvas({
    width:1080,height:1350,fillColor:"#fff"
  }).toBlob((blob) => {
    if (editingExtra){
      const url = URL.createObjectURL(blob);
      extraImages[currentSlotEdit] = url;
      extraBlobs[currentSlotEdit] = blob;
      renderExtraSlots();
      autoSave = true;
      elSalvar.click();
      editingExtra = false;
      currentSlotEdit = null;
      elPrev.style.display = "flex";
      document.getElementById("cropArea").style.display = "none";
    } else {
      const url = URL.createObjectURL(blob);
      elPrev.innerHTML = `<img src="${url}" alt="">`;
      croppedBlob = blob;
      autoSave = true;
      elSalvar.click();
      elPrev.style.display = "flex";
      document.getElementById("cropArea").style.display = "none";
    }
  }, "image/jpeg", 0.9);
});

/* SALVAR */
elSalvar.addEventListener('click', async () => {
  try{
    elSalvar.disabled = true;
    elStatus.textContent = 'Salvando...';
    elBar.style.width = '0%';
    elProg.textContent = '';

    const nome = elNome.value.trim();
    const descricao = elDesc.value.trim();
    const precoNumber = normalizePrecoToNumber(elPreco.value);
    let imageURL = currentImageUrl;

    // subir principal
    if (croppedBlob){
      const ext = "jpg";
      const storagePath = `produtos/${pid}-${Date.now()}.${ext}`;
      const storageRef = ref(st, storagePath);
      const task = uploadBytesResumable(storageRef, croppedBlob, { contentType: "image/jpeg" });
      task.on('state_changed',(snap)=>{
        const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
        elBar.style.width = pct + '%';
        elProg.textContent = `Enviando imagem… ${pct}%`;
      });
      await task;
      imageURL = await getDownloadURL(storageRef);
    }

    // extras
    let novasURLsExtras = [];
    for (let i=0; i<extraBlobs.length; i++){
      const blob = extraBlobs[i];
      if (!blob) continue;
      const ext = "jpg";
      const storagePath = `produtos/${pid}-${Date.now()}-${i}.${ext}`;
      const storageRef = ref(st, storagePath);
      const task2 = uploadBytesResumable(storageRef, blob, {contentType:"image/jpeg"});
      await new Promise(res=>{
        task2.on('state_changed', snap=>{
          const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
          elBar.style.width = pct + '%';
          elProg.textContent = `Enviando imagem extra… ${pct}%`;
        }, null, async ()=>{
          const urlExtra = await getDownloadURL(storageRef);
          novasURLsExtras.push(urlExtra);
          res();
        });
      });
    }

    if (novasURLsExtras.length > 0){
      for (let u of novasURLsExtras){
        extraImages.push(u);
      }
    }

    extraImages = extraImages.filter(u=>u && !u.startsWith("blob:")).slice(0,5);
    const payload = {
      nome,
      descricao,
      preco: precoNumber,
      imagem: imageURL || "",
      data: serverTimestamp(),
      imagens: extraImages
    };

    await setDoc(doc(db,'produtos', pid), payload, { merge: true });
    currentImageUrl = imageURL;
    elStatus.textContent = '';

    if (autoSave){
      autoSave = false;
      elStatus.textContent = 'Salvo!';
    } else {
      showToast();
    }

  } catch(err){
    console.error(err);
    elStatus.innerHTML = '<span class="err">Erro ao salvar. Veja o console.</span>';
    elBar.style.width = '0%';
  } finally {
    elSalvar.disabled = false;
    setTimeout(()=>{ elProg.textContent = ''; }, 1200);
  }
});
/* botão Selecionar foto principal */
document.getElementById("btnSelectImage").addEventListener("click", ()=>{
  const elFile = document.getElementById("file");
  if (elFile) elFile.click();
});

</script>

</body>
</html>
